<!DOCTYPE html>
<html>
<head>
    <title>排球場地報名系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .場地卡片 {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.07);
        }
        .場地卡片 h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        .場地卡片 p {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .場地卡片 ul {
            list-style-type: disc;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .場地卡片 button {
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }
        .場地統計卡片 {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.07);
        }
        .場地統計卡片 h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        .場地統計卡片 p {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .場地統計卡片 ul {
            list-style-type: disc;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center py-8">
    <div class="container max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-semibold text-gray-800 mb-4 text-center">排球場地報名系統</h1>
        <div id="功能選單" class="mb-4">
            <button id="報名表單" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">我要報名</button>
            <button id="報名確認表單" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">我的報名表單</button>
            <button id="管理員後台" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded hidden">管理員後台</button>
            <button id="登入" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">登入</button>
            <button id="登出" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded hidden">登出</button>
        </div>

        <div id="報名表單內容" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">可報名場地</h2>
            <div id="場地列表篩選器" class="mb-4 flex flex-wrap gap-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" value="和平排球場">
                    <span class="ml-2 text-gray-700 text-sm">和平排球場</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" value="中正排球場">
                    <span class="ml-2 text-gray-700 text-sm">中正排球場</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" value="校本部">
                    <span class="ml-2 text-gray-700 text-sm">校本部</span>
                </label>
            </div>
            <div id="場地列表內容">
                <p class="text-gray-500 text-sm">載入場地資料中...</p>
            </div>
        </div>

        <div id="報名確認表單內容" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">我的報名表單</h2>
            <div id="我的報名篩選器" class="mb-4 flex flex-wrap gap-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600 rounded" value="和平排球場">
                    <span class="ml-2 text-gray-700 text-sm">和平排球場</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600 rounded" value="中正排球場">
                    <span class="ml-2 text-gray-700 text-sm">中正排球場</span>
                </label>
                 <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600 rounded" value="校本部">
                    <span class="ml-2 text-gray-700 text-sm">校本部</span>
                </label>
            </div>
            <ul>
                <li class="text-gray-500 text-sm">載入報名資料中...</li>
            </ul>
        </div>

        <div id="管理員後台內容" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">場地統計資料</h2>
            <div class="text-gray-500 text-sm">載入場地統計資料中...</div>
        </div>

        <div id="登入表單" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">登入</h2>
            <form id="登入表單內容" class="space-y-4">
                <div>
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">密碼:</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-sm">登入</button>
            </form>
            <div id="登入錯誤訊息" class="text-red-500 text-xs italic mt-4" style="display: none;"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyB8PzKSCgIl0_JIVxetSK3Lujwpqr-eEJA",
            authDomain: "volleyballweb-6476a.firebaseapp.com",
            projectId: "volleyballweb-6476a",
            storageBucket: "volleyballweb-6476a.firebasestorage.app",
            messagingSenderId: "107455998937",
            appId: "1:107455998937:web:1203dc9377ccf38a2547c8",
            measurementId: "G-1J504YXCHY"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 頁面元素
        const 功能選單 = document.getElementById('功能選單');
        const 報名表單按鈕 = document.getElementById('報名表單');
        const 報名確認表單按鈕 = document.getElementById('報名確認表單');
        const 管理員後台按鈕 = document.getElementById('管理員後台');
        const 登入按鈕 = document.getElementById('登入');
        const 登出按鈕 = document.getElementById('登出');
        const 報名表單內容 = document.getElementById('報名表單內容');
        const 場地列表內容 = document.getElementById('場地列表內容');
        const 場地列表篩選器 = {
            和平: document.querySelector('input[value="和平排球場"]'),
            中正: document.querySelector('input[value="中正排球場"]'),
            校本部: document.querySelector('input[value="校本部"]')
        };
        const 報名確認表單內容 = document.getElementById('報名確認表單內容');
        const 我的報名篩選器 = {
            和平: document.querySelector('input[value="和平排球場"]'),
            中正: document.querySelector('input[value="中正排球場"]'),
            校本部: document.querySelector('input[value="校本部"]')
        };
        const 管理員後台內容 = document.getElementById('管理員後台內容');
        const 登入表單 = document.getElementById('登入表單');
        const 登入表單內容 = document.getElementById('登入表單內容');
        const 登入錯誤訊息 = document.getElementById('登入錯誤訊息');

        let currentUser = null;
        let userRole = 'user'; // 預設為一般使用者

        // 顯示/隱藏頁面
        function showPage(pageId) {
            報名表單內容.classList.add('hidden');
            報名確認表單內容.classList.add('hidden');
            管理員後台內容.classList.add('hidden');
            登入表單.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        // 檢查使用者角色
        function checkUserRole() {
            if (currentUser) {
                const userRef = db.collection('users').doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        userRole = doc.data().role;
                        if (userRole === 'admin') {
                            管理員後台按鈕.classList.remove('hidden');
                            載入場地統計資料();
                        } else {
                            管理員後台按鈕.classList.add('hidden');
                        }
                        登入按鈕.classList.add('hidden');
                        登出按鈕.classList.remove('hidden');
                        功能選單.querySelectorAll('button').forEach(button => button.disabled = false);
                        if (!已載入場地) 載入場地資料();
                        if (!已載入我的報名) 載入我的報名資料();
                    } else {
                        // 如果找不到使用者文件，則視為一般使用者
                        userRole = 'user';
                        管理員後台按鈕.classList.add('hidden');
                        登入按鈕.classList.remove('hidden');
                        登出按鈕.classList.add('hidden');
                        功能選單.querySelectorAll('button').forEach(button => button.disabled = false);
                        if (!已載入場地) 載入場地資料();
                        if (!已載入我的報名) 載入我的報名資料();
                    }
                }).catch((error) => {
                    console.error("Error getting user role:", error);
                    alert("Error getting user role. Please try again.");
                });
            } else {
                userRole = 'user';
                管理員後台按鈕.classList.add('hidden');
                登入按鈕.classList.remove('hidden');
                登出按鈕.classList.add('hidden');
                功能選單.querySelectorAll('button').forEach(button => button.disabled = true);
                登入按鈕.disabled = false;
                showPage('登入表單');
            }
        }

        // 登入
        登入表單內容.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    checkUserRole();
                })
                .catch((error) => {
                    登入錯誤訊息.textContent = error.message;
                    登入錯誤訊息.style.display = 'block';
                });
        });

        // 登出
        登出按鈕.addEventListener('click', () => {
            auth.signOut().then(() => {
                currentUser = null;
                userRole = 'user';
                管理員後台按鈕.classList.add('hidden');
                登入按鈕.classList.remove('hidden');
                登出按鈕.classList.add('hidden');
                功能選單.querySelectorAll('button').forEach(button => button.disabled = true);
                登入按鈕.disabled = false;
                showPage('登入表單');
                場地列表內容.innerHTML = '<p class="text-gray-500 text-sm">請先登入以查看場地資料。</p>';
                報名確認表單內容.innerHTML = '<p class="text-gray-500 text-sm">請先登入以查看報名資料。</p>';
            }).catch((error) => {
                console.error('登出失敗', error);
                alert('登出失敗，請重試。' + error.message);
            });
        });

        // 功能選單事件
        報名表單按鈕.addEventListener('click', () => showPage('報名表單內容'));
        報名確認表單按鈕.addEventListener('click', () => showPage('報名確認表單內容'));
        管理員後台按鈕.addEventListener('click', () => showPage('管理員後台內容'));
        登入按鈕.addEventListener('click', () => showPage('登入表單'));

        let 已載入場地 = false;
        // 載入場地資料
        function 載入場地資料() {
            場地列表內容.innerHTML = '<p class="text-gray-500 text-sm">載入場地資料中...</p>';
            db.collection('場地').get()
                .then((snapshot) => {
                    場地列表內容.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const 場地資料 = doc.data();
                        const 場地卡片 = document.createElement('div');
                        場地卡片.className = '場地卡片';
                        場地卡片.innerHTML = `
                            <h3>${場地資料.場次}</h3>
                            <p>場地位置：${場地資料.場地位置}</p>
                            <p>日期：${場地資料.日期}</p>
                            <p>時間：${場地資料.開始時間} - ${場地資料.結束時間}</p>
                            <p>費用：${場地資料.費用} 元</p>
                            <p>
                                性別限制：
                                <label><input type="radio" name="gender-${doc.id}" value="male"> 男</label>
                                <label><input type="radio" name="gender-${doc.id}" value="female"> 女</label>
                            </p>
                            <p>報名人數：${場地資料.報名人數} / ${場地資料.男生人數 + 場地資料.女生人數}</p>
                            <button class="btn-primary bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" data-場地id="${doc.id}">我要報名</button>
                            ${userRole === 'admin' ? `<button type="button" class="btn-secondary bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm" data-場地id="${doc.id}">取消場地</button>` : ''}
                        `;
                        場地列表內容.appendChild(場地卡片);

                        // 篩選器事件
                        Object.entries(場地列表篩選器).forEach(([key, filter]) => {
                            filter.addEventListener('change', () => {
                                if (filter.checked) {
                                    場地卡片.classList.remove('hidden');
                                } else {
                                    if (!場地卡片.querySelector(`p:nth-of-type(2)`).textContent.includes(filter.value)) {
                                        場地卡片.classList.add('hidden');
                                    }
                                }
                            });
                        });

                        // "我要報名" 按鈕事件
                        const 報名按鈕 = 場地卡片.querySelector('.btn-primary');
                        報名按鈕.addEventListener('click', () => {
                            if (!currentUser) {
                                alert('請先登入才能報名場地。');
                                return;
                            }

                            const 性別選擇器 = 場地卡片.querySelector(`input[name="gender-${doc.id}"]:checked`);
                            if (!性別選擇器) {
                                alert('請選擇您的性別。');
                                return;
                            }

                            const 性別 = 性別選擇器.value;
                            const 場地id = 報名按鈕.dataset.場地id;

                            db.collection('場地').doc(場地id).get()
                                .then((場地文件) => {
                                    if (場地文件.exists) {
                                        const 場地資料 = 場地文件.data();
                                        if (場地資料.報名人數 < 場地資料.男生人數 + 場地資料.女生人數) {
                                            // 檢查是否已報名過
                                            if (場地資料.已報名者 && 場地資料.已報名者.includes(currentUser.uid)) {
                                                alert('您已報名過此場地。');
                                                return;
                                            }

                                            // 檢查性別限制
                                            let 符合性別限制 = false;
                                            if (性別 === 'male' && 場地資料.男生人數 > 0) {
                                                符合性別限制 = true;
                                            } else if (性別 === 'female' && 場地資料.女生人數 > 0) {
                                                符合性別限制 = true;
                                            }

                                            if (!符合性別限制) {
                                                alert('此場地已達性別人數限制。');
                                                return;
                                            }

                                            // 更新報名人數、已報名者和已報名者性別
                                            db.collection('場地').doc(場地id).update({
                                                報名人數: 場地資料.報名人數 + 1,
                                                已報名者: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                                                [`已報名者性別.${currentUser.uid}`]: 性別 // 儲存性別
                                            })
                                                .then(() => {
                                                    console.log('報名成功');
                                                    alert('報名成功！');
                                                    載入場地資料();
                                                    載入我的報名資料();
                                                })
                                                .catch((error) => {
                                                    console.error('報名失敗', error);
                                                    alert('報名失敗，請重試。' + error.message);
                                                });
                                        } else {
                                            alert('此場地已額滿。');
                                        }
                                    } else {
                                        console.error('找不到場地');
                                        alert('找不到場地，請重試。');
                                    }
                                })
                                .catch((error) => {
                                    console.error('Error getting document:', error);
                                    alert('發生錯誤，請重試。' + error.message);
                                });
                        });

                        // "取消場地" 按鈕事件 (僅管理員顯示)
                        const 取消場地按鈕 = 場地卡片.querySelector('.btn-secondary');
                        if (取消場地按鈕) {
                            取消場地按鈕.addEventListener('click', () => {
                                const 場地id = 取消場地按鈕.dataset.場地id;
                                if (confirm('確定要取消此場地嗎？')) {
                                    db.collection('場地').doc(場地id).delete()
                                        .then(() => {
                                            console.log('場地已取消');
                                            alert('場地已取消！');
                                            載入場地資料();
                                            載入我的報名資料();
                                        })
                                        .catch((error) => {
                                            console.error('取消場地失敗', error);
                                            alert('取消場地失敗，請重試。' + error.message);
                                        });
                                }
                            });
                        }
                    });
                    已載入場地 = true;
                })
                .catch((error) => {
                    console.error('載入場地資料失敗', error);
                    alert('載入場地資料失敗，請重試。' + error.message);
                });
        }

        let 已載入我的報名 = false;
        // 載入我的報名資料
        function 載入我的報名資料() {
            if (!currentUser) return;

            報名確認表單內容.innerHTML = '';
            db.collection('場地').where('已報名者', 'array-contains', currentUser.uid).get()
                .then((snapshot) => {
                    snapshot.forEach((doc) => {
                        const 場地資料 = doc.data();
                        const 報名項目 = document.createElement('li');
                        const 性別 = 場地資料.已報名者性別[currentUser.uid]; // 取得報名者的性別
                        報名項目.innerHTML = `
                            <span class="text-sm">場次：${場地資料.場次}</span>
                            <span class="text-sm">場地位置：${場地資料.場地位置}</span>
                            <span class="text-sm">日期：${場地資料.日期}</span>
                            <span class="text-sm">時間：${場地資料.開始時間} - ${場地資料.結束時間}</span>
                            <span class="text-sm">您的性別：${性別 === 'male' ? '男' : '女'}</span>
                            <button class="btn-secondary bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm" data-場地id="${doc.id}">取消報名</button>
                        `;
                        報名確認表單內容.appendChild(報名項目);

                         // 篩選器事件
                        Object.entries(我的報名篩選器).forEach(([key, filter]) => {
                            filter.addEventListener('change', () => {
                                if (filter.checked) {
                                     報名項目.classList.remove('hidden');
                                } else {
                                     if (!報名項目.querySelector(`span:nth-of-type(2)`).textContent.includes(filter.value)) {
                                         報名項目.classList.add('hidden');
                                     }
                                }
                            });
                        });

                        // "取消報名" 按鈕事件
                        const 取消報名按鈕 = 報名項目.querySelector('.btn-secondary');
                        取消報名按鈕.addEventListener('click', ()=> {
                            const 場地id = 取消報名按鈕.dataset.場地id;
                            if (confirm('確定要取消報名嗎？')) {
                                db.collection('場地').doc(場地id).get()
                                    .then((場地文件) => {
                                        if (場地文件.exists) {
                                            const 場地資料 = 場地文件.data();
                                            // 檢查是否真的有報名
                                            if (場地資料.已報名者 && 場地資料.已報名者.includes(currentUser.uid)) {
                                                // 更新報名人數、已報名者和已報名者性別
                                                db.collection('場地').doc(場地id).update({
                                                    報名人數: 場地資料.報名人數 - 1,
                                                    已報名者: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
                                                    [`已報名者性別.${currentUser.uid}`]: firebase.firestore.FieldValue.delete() // 移除性別
                                                })
                                                    .then(() => {
                                                        console.log('取消報名成功');
                                                        alert('取消報名成功！');
                                                        載入場地資料();
                                                        載入我的報名資料();
                                                    })
                                                    .catch((error) => {
                                                        console.error('取消報名失敗', error);
                                                        alert('取消報名失敗，請重試。' + error.message);
                                                    });
                                            } else {
                                                alert('您尚未報名此場地。'); // 避免重複取消報名
                                            }
                                        } else {
                                            console.error('找不到場地');
                                            alert('找不到場地，請重試。');
                                        }
                                    })
                                    .catch((error) => {
                                        console.error('Error getting document:', error);
                                        alert('發生錯誤，請重試。' + error.message);
                                    });
                            }
                        });
                    });
                    已載入我的報名 = true;
                })
                .catch((error) => {
                    console.error('載入我的報名資料失敗', error);
                    alert('載入我的報名資料失敗，請重試。' + error.message);
                });
        }

        // 載入場地統計資料 (僅管理員)
        function 載入場地統計資料() {
            管理員後台內容.innerHTML = '';
            db.collection('場地').get()
                .then((snapshot) => {
                    const 場地統計資料 = {};
                    snapshot.forEach((doc) => {
                        const 場地 = doc.data();
                        if (!場地統計資料[場地.場地位置]) {
                            場地統計資料[場地.場地位置] = {
                                總人數: 0,
                                場次: [],
                                費用加總: 0
                            };
                        }
                        場地統計資料[場地.場地位置].總人數 += 場地.報名人數;
                        場地統計資料[場地.場地位置].場次.push(場地.場次);
                        場地統計資料[場地.場地位置].費用加總 += 場地.費用;
                    });

                    for (const 場地位置 in 場地統計資料) {
                        const 統計卡片 = document.createElement('div');
                        統計卡片.className = '場地統計卡片';
                        統計卡片.innerHTML = `
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${場地位置}</h3>
                            <p class="text-sm text-gray-700 mb-1">總報名人數：${場地統計資料[場地位置].總人數}</p>
                            <p class="text-sm text-gray-700 mb-1">總費用：${場地統計資料[場地位置].費用加總} 元</p>
                            <p class="text-sm text-gray-700 mb-1">場次：</p>
                            <ul class="list-disc list-inside">
                                ${場地統計資料[場地位置].場次.map(場次 => `<li class="text-sm text-gray-700">${場次}</li>`).join('')}
                            </ul>
                        `;
                        管理員後台內容.appendChild(統計卡片);
                    }
                })
                .catch((error) => {
                    console.error('載入場地統計資料失敗', error);
                    alert('載入場地統計資料失敗，請重試。' + error.message);
                });
        }

        // 初始載入
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            checkUserRole();
        });
    </script>
</body>
</html>
